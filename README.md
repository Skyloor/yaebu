# Telegram TON Mini‑App Betting Platform (русская версия)

Этот репозиторий содержит исходный код демонстрационной Telegram Mini‑приложения, позволяющего двум игрокам заключать пари в TON на классические игры — «Камень‑Ножницы‑Бумага», Дурак, шашки и шахматы.  Ставки обеих сторон депонируются в смарт‑контракте эскроу TON, который по завершении игры выплачивает банк победителю минус 1 % рейка администратору.  Всё работает локально с использованием Docker‑контейнеров для Postgres и Redis, backend на Fastify для REST/WS API, Telegram‑бота, фронтенда на React/Vite и смарт‑контракта на Tact.

## Структура проекта

```text
telegram-miniapp-betting/
├── .env.sample        # Пример файла конфигурации окружения
├── docker-compose.yml # Локальные сервисы Postgres и Redis
├── package.json       # Настройка рабочей среды PNPM
├── pnpm-workspace.yaml
├── README.md          # Описание на английском
├── README_RU.md       # Описание на русском (этот файл)
├── apps/              # Отдельные приложения
│   ├── backend/       # Fastify REST/WS API и бизнес‑логика
│   ├── bot/           # Telegram‑бот, запускающий Mini App
│   ├── contracts/     # Смарт‑контракт эскроу TON и тесты
│   └── frontend/      # Vite/React Mini‑приложение
└── packages/
    └── shared/        # Общие типы и утилиты
```

### Приложения

- **frontend** – веб‑клиент на Vite + React + TypeScript.  Интегрируется с API Telegram Mini Apps через `window.Telegram.WebApp`, поддерживает светлую и тёмную тему, подключает TON‑кошельки через [`@tonconnect/ui-react`](https://github.com/tonconnect/sdk) и общается с backend через REST и Socket.IO.  Лобби отображает список комнат, позволяет создавать и присоединяться.  В матче все ходы и таймеры синхронизируются по websockets.

- **backend** – сервер Fastify, который валидирует `initData` от Mini App, управляет сессиями, лобби, матчами, таймерами, эскроу TON и определяет исход игр.  Данные хранятся в Postgres, временные состояния — в Redis.  Реализованы HTTP‑эндпоинты и namespaces Socket.IO.  Бизнес‑правила (тайм‑ауты, commit‑reveal для RPS, валидация ходов) живут здесь.

- **bot** – Telegram‑бот на [Telegraf](https://telegraf.js.org/), который отвечает на `/start` и `/help`, отправляет клавиатуру с кнопкой `web_app` для запуска Mini App, обрабатывает данные, возвращаемые из Mini App, и создаёт глубокие ссылки (deep‑links) для приватных комнат.

- **contracts** – смарт‑контракт эскроу на языке [Tact](https://github.com/tact-lang/tact).  Контракт принимает депозиты от двух игроков, удерживает банк, выплачивает победителю (минус рейк) и поддерживает возврат ставок по тайм‑ауту.  Приложены простые unit‑тесты на JavaScript, моделирующие логику на уровне приложения.

### Общие пакеты

- **shared** – общие типы TypeScript и утилиты, используемые и фронтендом, и бэкендом.  Позволяет не дублировать определения сущностей.

## Быстрый старт

1. **Клонируйте** репозиторий и скопируйте `.env.sample` в `.env`.  Заполните переменные окружения (`BOT_TOKEN`, `ADMIN_TON_ADDRESS`, `JWT_SECRET` и др.) в соответствии с вашими настройками.  Стандартные порты Postgres и Redis указаны в `docker-compose.yml`.

2. **Установите зависимости**.  Требуются Node JS ≥ 20 и PNPM.  Выполните:

   ```bash
   pnpm install
   ```

3. **Запустите сервисы**.  Сначала поднимите Postgres и Redis командой:

   ```bash
   docker compose up -d
   ```

   Затем в другой консоли запустите контракт, backend, бота и фронтенд:

   ```bash
   # (опционально) сборка и тестирование смарт‑контракта
   pnpm dev:contracts

   # Backend API на http://localhost:4000
   pnpm dev:backend

   # Telegram‑бот (требуется BOT_TOKEN в .env)
   pnpm dev:bot

   # Vite фронтенд на http://localhost:5173
   pnpm dev:frontend
   ```

4. **Откройте Mini App**.  Отправьте команду `/start` вашему боту в Telegram — он пришлёт кнопку «Play», открывающую Mini App.  Либо перейдите на `http://localhost:5173/` в браузере (хотя без параметра `initData` функциональность будет ограничена).

## Важные моменты

- **Валидация initData** – Telegram передаёт подпись и данные в строке `initData` при запуске Mini App.  Бэкенд проверяет корректность HMAC‑SHA256 подписи, рассчитывая её с использованием секретного токена бота.  Срок действия `auth_date` ограничен (по умолчанию 1 час).

- **Эскроу TON** – смарт‑контракт хранит общую ставку.  По завершении матча backend вызывает `resolve()` и контракт перечисляет банк победителю за вычетом 1 % администратору.  При истечении тайм‑аутов вызывается `refund()`, возвращая деньги игрокам.

- **Реальное время** – вся игровая логика происходит на сервере, а клиенты лишь отображают состояние.  Обмен ходами, commit/reveal и отсчёт таймеров реализованы через Socket.IO.

- **Локализация** – интерфейсы фронтенда и сообщения бэкенда поддерживают русский и английский языки.  Язык выбирается по `initData` или переключается вручную.

Этот проект служит отправной точкой и демонстрацией для дальнейшей доработки.  Он не предназначен для коммерческого использования без глубокого аудита безопасности и соблюдения законодательства.